# Исправление обработки значения страны в API создания PaymentIntent

## Обнаруженная проблема

На основе нашего анализа обнаружены две проблемы:

1. API `create-payment-intent` не учитывает параметр `country` из запроса, всегда используя значение из профиля пользователя, что делает невозможным тестирование или явное указание страны.

2. Отсутствует корректная обработка случая, когда значение страны равно 'unknown', что может происходить если:
   - В профиле пользователя страна не указана
   - Переданная в запросе страна не распознается

## Предложенные исправления

### 1. Улучшение логики выбора страны (`server-country-fix.patch`)

Первый патч добавляет:
- Возможность явно указывать страну в запросе (в теле или URL-параметрах)
- Поддержку флага `force_country` для принудительного использования переданной страны
- Дополнительное логирование и метаданные для лучшей отладки

### 2. Обработка неизвестной страны (`server-fix-unknown-country.patch`)

Второй патч добавляет:
- Явную обработку случая `country === 'unknown'` с нулевой ставкой налога
- Дополнительное логирование при работе с неизвестными странами
- Понятную метку налога для неизвестных локаций: `'No Tax (Unknown Location)'`

## Инструкции по применению

Для применения предложенных исправлений:

1. Примените оба патча к файлу `server/routes.ts`:

```bash
# Для первого патча (улучшение логики выбора страны)
patch server/routes.ts server-country-fix.patch

# Для второго патча (обработка неизвестной страны)
patch server/routes.ts server-fix-unknown-country.patch
```

2. При конфликтах объедините изменения вручную, приоритезируя:
   - Корректную логику выбора страны
   - Явную обработку случая с неизвестной страной

## Дополнительные рекомендации

1. Добавьте валидацию кода страны при регистрации пользователя, чтобы предотвратить сохранение недопустимых значений.

2. Рассмотрите возможность хранения не только кода страны, но и региона/юрисдикции для более точного расчета налогов.

3. Для тестирования, используйте новый флаг `force_country: true` вместе с параметром `country`, например:
   ```json
   {
     "amount": 10000,
     "userId": 1,
     "productId": 1,
     "currency": "eur",
     "country": "FR",
     "force_country": true
   }
   ```