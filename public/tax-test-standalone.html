<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tax Testing App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone@7.18.5/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    // Используем React в режиме строгого контроля
    const { useState } = React;
    
    // Форматирование цены
    const formatPrice = (amount, currency) => {
      const formatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currency === 'eur' ? 'EUR' : 'USD',
        minimumFractionDigits: 2,
      });
      
      return formatter.format(amount / 100);
    };
    
    // Расчет налоговой ставки на основе страны
    const calculateTaxRate = (country) => {
      const euVatRates = {
        'DE': { rate: 0.19, label: 'MwSt. 19%' }, // Germany
        'FR': { rate: 0.20, label: 'TVA 20%' },   // France
        'IT': { rate: 0.22, label: 'IVA 22%' },   // Italy
        'ES': { rate: 0.21, label: 'IVA 21%' },   // Spain
        'GB': { rate: 0.20, label: 'VAT 20%' },   // United Kingdom
        'US': { rate: 0, label: 'No Sales Tax' }, // USA
      };
      
      return euVatRates[country] || { rate: 0, label: 'No Tax' };
    };
    
    // Выбор валюты на основе страны
    const getCurrencyForCountry = (country) => {
      // Список стран, использующих EUR
      const eurCountries = [
        'AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 
        'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 
        'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'
      ];
      
      return eurCountries.includes(country) ? 'eur' : 'usd';
    };
    
    // Цены продукта
    const prices = {
      usd: 284500, // $2,845
      eur: 276000  // €2,760
    };
    
    // Упрощенный компонент для отображения информации о налоге
    function TaxDisplayBox({ country, currency, baseAmount, taxAmount, taxRate, taxLabel, showDebugInfo = false }) {
      const displayCountry = country || 'DE';
      
      return (
        <div className="mt-4 p-3 bg-gray-50 rounded-md border border-gray-200 shadow-sm">
          <div className="flex justify-between font-medium">
            <span className="text-sm text-gray-800 flex items-center">
              {taxLabel}
              <span className="ml-2 px-1 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">{displayCountry.toUpperCase()}</span>
            </span>
            <span className="text-sm font-semibold">
              {formatPrice(taxAmount, currency)}
            </span>
          </div>
          
          {taxAmount > 0 && (
            <div className="flex justify-between text-sm mt-2 text-gray-700 pt-2 border-t border-gray-200">
              <span>Total with Tax</span>
              <span className="font-semibold">{formatPrice(baseAmount + taxAmount, currency)}</span>
            </div>
          )}
          
          {/* Пояснение о налогах */}
          <div className="mt-2 text-xs text-gray-500">
            {displayCountry === 'DE' ? (
              <div className="italic">* Price excludes VAT, which is added at checkout</div>
            ) : displayCountry === 'US' ? (
              <div className="italic">* No sales tax is applied as nexus thresholds haven't been reached</div>
            ) : (
              <div className="italic">* Tax rates are calculated based on your location</div>
            )}
          </div>
          
          {showDebugInfo && (
            <div className="mt-2 text-xs text-gray-500 border-t border-gray-200 pt-2">
              <div>Debug: Country: {country}</div>
              <div>Tax Rate: {(taxRate * 100).toFixed(2)}%</div>
              <div>Base Amount: {formatPrice(baseAmount, currency)}</div>
              <div>Tax Amount: {formatPrice(taxAmount, currency)}</div>
              <div>Total: {formatPrice(baseAmount + taxAmount, currency)}</div>
            </div>
          )}
        </div>
      );
    }
    
    // Класс для создания, получения и обновления PaymentIntent
    class PaymentService {
      static async createPaymentIntent(productId, amount, currency, country) {
        try {
          // Запрос к API для создания PaymentIntent
          const response = await fetch('/api/tax-debug/create-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              productId,
              userId: 1, // Тестовый пользователь
              amount, 
              currency, 
              country 
            })
          });
          
          if (!response.ok) {
            throw new Error('Failed to create payment intent');
          }
          
          return await response.json();
        } catch (error) {
          console.error('Error creating payment intent:', error);
          throw error;
        }
      }
    }
    
    // Основное приложение
    function App() {
      const countries = [
        { code: 'DE', name: 'Germany' },
        { code: 'FR', name: 'France' },
        { code: 'IT', name: 'Italy' },
        { code: 'ES', name: 'Spain' },
        { code: 'US', name: 'United States' },
        { code: 'GB', name: 'United Kingdom' }
      ];
      
      // Состояние приложения
      const [selectedCountry, setSelectedCountry] = useState('DE');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [paymentIntent, setPaymentIntent] = useState(null);
      
      // Локальный расчет налогов на основе выбранной страны
      const currency = getCurrencyForCountry(selectedCountry);
      const baseAmount = prices[currency];
      const { rate, label } = calculateTaxRate(selectedCountry);
      const taxAmount = Math.round(baseAmount * rate);
      
      // Создание PaymentIntent с налоговой информацией
      const handleCreatePaymentIntent = async () => {
        setLoading(true);
        setError(null);
        
        try {
          const paymentIntentData = await PaymentService.createPaymentIntent(
            1, // ID продукта
            baseAmount,
            currency,
            selectedCountry
          );
          
          setPaymentIntent(paymentIntentData);
        } catch (error) {
          setError('Failed to create payment intent: ' + error.message);
        } finally {
          setLoading(false);
        }
      };
      
      return (
        <div className="container mx-auto p-4 max-w-3xl">
          <header className="text-center mb-8">
            <h1 className="text-2xl font-bold mb-2">Tax Calculation Demo</h1>
            <p className="text-gray-600">
              This page demonstrates tax calculation for different countries
            </p>
          </header>
          
          <div className="mb-6 p-4 border rounded-lg bg-gray-50">
            <h2 className="text-lg font-semibold mb-3">Select Country</h2>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
              {countries.map(country => (
                <button
                  key={country.code}
                  className={`p-2 rounded border ${
                    selectedCountry === country.code 
                    ? 'bg-blue-600 text-white border-blue-700' 
                    : 'bg-white hover:bg-gray-100 border-gray-300'
                  }`}
                  onClick={() => {
                    setSelectedCountry(country.code);
                    setPaymentIntent(null);
                  }}
                >
                  {country.name}
                </button>
              ))}
            </div>
          </div>
          
          <div className="border rounded-lg p-4 mb-6">
            <h2 className="text-lg font-semibold mb-3">Product Information</h2>
            
            <div className="mb-4 p-3 bg-white rounded border">
              <div className="flex justify-between items-center">
                <div>
                  <h3 className="font-medium">AI-Driven Solutions</h3>
                  <p className="text-sm text-gray-600">
                    Professional AI Platform
                  </p>
                </div>
                <div className="text-xl font-semibold">
                  {formatPrice(baseAmount, currency)}
                </div>
              </div>
            </div>
            
            <div className="border-t pt-4 mt-4">
              <table className="w-full">
                <tbody>
                  <tr>
                    <td className="pb-2">Subtotal:</td>
                    <td className="text-right pb-2">{formatPrice(baseAmount, currency)}</td>
                  </tr>
                  <tr className="bg-yellow-50">
                    <td className="py-2">
                      <span className="flex items-center">
                        {label}
                        <span className="ml-2 bg-blue-100 text-blue-700 text-xs rounded px-1">
                          {selectedCountry}
                        </span>
                      </span>
                    </td>
                    <td className="text-right py-2">{formatPrice(taxAmount, currency)}</td>
                  </tr>
                  <tr className="font-bold border-t">
                    <td className="pt-2">Total:</td>
                    <td className="text-right pt-2">{formatPrice(baseAmount + taxAmount, currency)}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <div className="mb-6">
            <button 
              className="w-full py-2 px-4 bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
              onClick={handleCreatePaymentIntent}
              disabled={loading}
            >
              {loading ? 'Creating Payment Intent...' : 'Create Payment Intent'}
            </button>
            
            {error && (
              <div className="mt-2 p-3 bg-red-100 text-red-700 rounded">
                {error}
              </div>
            )}
            
            {paymentIntent && (
              <div className="mt-4 p-4 border rounded bg-green-50">
                <h3 className="font-semibold mb-2">Payment Intent Created:</h3>
                <div className="text-sm">
                  <div><strong>Client Secret:</strong> <span className="font-mono text-xs">{paymentIntent.clientSecret}</span></div>
                  <div><strong>Order ID:</strong> {paymentIntent.orderId}</div>
                  
                  <div className="mt-3 p-3 bg-white border rounded">
                    <div className="font-semibold mb-1">Tax Information:</div>
                    <div><strong>Amount:</strong> {formatPrice(paymentIntent.tax.amount, currency)}</div>
                    <div><strong>Rate:</strong> {(paymentIntent.tax.rate * 100).toFixed(2)}%</div>
                    <div><strong>Label:</strong> {paymentIntent.tax.label}</div>
                    <div><strong>Display:</strong> {paymentIntent.tax.display}</div>
                  </div>
                </div>
              </div>
            )}
          </div>
          
          <div className="mb-6">
            <h2 className="text-lg font-semibold mb-3">Tax Display Component</h2>
            
            <TaxDisplayBox 
              country={selectedCountry}
              currency={currency}
              baseAmount={baseAmount}
              taxAmount={taxAmount}
              taxRate={rate}
              taxLabel={label}
              showDebugInfo={true}
            />
            
            {paymentIntent && (
              <div className="mt-4">
                <h3 className="font-semibold mb-2">Tax Display with Stripe Data:</h3>
                <TaxDisplayBox 
                  country={selectedCountry}
                  currency={currency}
                  baseAmount={baseAmount}
                  taxAmount={paymentIntent.tax.amount}
                  taxRate={paymentIntent.tax.rate}
                  taxLabel={paymentIntent.tax.label}
                  showDebugInfo={true}
                />
              </div>
            )}
          </div>
          
          <div className="text-sm text-gray-500 border-t pt-4">
            <p>This is a standalone demo page that doesn't require authentication or context.</p>
            <p>It demonstrates how the tax calculation works with Stripe integration.</p>
          </div>
        </div>
      );
    }
    
    // Рендерим наше приложение в DOM
    const rootNode = document.getElementById('root');
    const root = ReactDOM.createRoot(rootNode);
    root.render(<App />);
  </script>
</body>
</html>