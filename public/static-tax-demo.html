<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tax Calculation Demo</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.5;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      color: #333;
    }
    .container {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    h1, h2 {
      color: #2c3e50;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    input, select, button {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    button {
      background: #4caf50;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: 500;
    }
    button:hover {
      background: #45a049;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      background: #e8f5e9;
      border-radius: 4px;
      white-space: pre-wrap;
      overflow-x: auto;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
    }
    .card-element {
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: white;
    }
    .checkout-section {
      margin-top: 30px;
    }
    .hidden {
      display: none;
    }
    .tax-info {
      margin-top: 15px;
      padding: 10px;
      background: #e3f2fd;
      border-radius: 4px;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .summary {
      margin-top: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    .total {
      font-weight: bold;
      border-top: 1px solid #ddd;
      padding-top: 8px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h1>Stripe Tax Calculation Demo</h1>
  
  <div class="container">
    <h2>Create Payment Intent with Tax</h2>
    <div class="form-group">
      <label for="amount">Amount (in cents)</label>
      <input type="number" id="amount" value="1000" min="50">
    </div>
    <div class="form-group">
      <label for="currency">Currency</label>
      <select id="currency">
        <option value="usd">USD</option>
        <option value="eur">EUR</option>
        <option value="gbp">GBP</option>
      </select>
    </div>
    <div class="form-group">
      <label for="country">Country</label>
      <select id="country">
        <option value="US">United States</option>
        <option value="DE">Germany</option>
        <option value="FR">France</option>
        <option value="IT">Italy</option>
        <option value="ES">Spain</option>
        <option value="GB">United Kingdom</option>
        <option value="CA">Canada</option>
        <option value="AU">Australia</option>
      </select>
    </div>
    <button id="createPaymentIntent">Calculate Tax & Create Payment Intent</button>
    <div id="paymentResult" class="result hidden"></div>
    <div id="paymentError" class="error hidden"></div>
    
    <div id="taxSummary" class="tax-info hidden">
      <h3>Tax Summary</h3>
      <div id="taxDetails"></div>
    </div>
  </div>
  
  <div id="checkoutContainer" class="container checkout-section hidden">
    <h2>Complete Payment</h2>
    <div class="summary">
      <div class="summary-item">
        <span>Subtotal:</span>
        <span id="subtotal"></span>
      </div>
      <div class="summary-item">
        <span>Tax:</span>
        <span id="taxAmount"></span>
      </div>
      <div class="summary-item total">
        <span>Total:</span>
        <span id="totalAmount"></span>
      </div>
    </div>
    
    <div class="form-group">
      <label for="card-element">Credit or debit card</label>
      <div id="card-element" class="card-element"></div>
      <div id="card-errors" class="error hidden"></div>
    </div>
    
    <button id="submitPayment">Pay Now</button>
    <div id="confirmationResult" class="result hidden"></div>
  </div>
  
  <script>
    // Global variables
    let stripe = Stripe('pk_test_51NqqpbAiJjJJTX2U1oLILbuDyWZRHxptVXzMZx3tC79QVSfQtWa6o9pfvnKsT2EBLiTVyfP37ghrJTHXdRVFngmB00yIHEXDQq');
    let paymentIntent;
    let clientSecret;
    let card;
    
    // Форматирование валюты
    function formatCurrency(amount, currency) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currency.toUpperCase()
      }).format(amount / 100);
    }
    
    // 1. Создание Payment Intent с расчетом налога
    document.getElementById('createPaymentIntent').addEventListener('click', async function() {
      const amount = document.getElementById('amount').value;
      const currency = document.getElementById('currency').value;
      const country = document.getElementById('country').value;
      
      const resultElement = document.getElementById('paymentResult');
      const errorElement = document.getElementById('paymentError');
      const taxSummary = document.getElementById('taxSummary');
      
      resultElement.classList.add('hidden');
      errorElement.classList.add('hidden');
      taxSummary.classList.add('hidden');
      
      try {
        const response = await fetch('/api/tax-debug/create-payment-intent', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            productId: 1,
            userId: 1,
            amount: parseInt(amount),
            currency: currency,
            country: country
          })
        });
        
        if (!response.ok) {
          throw new Error('Server responded with an error');
        }
        
        const result = await response.json();
        paymentIntent = result;
        clientSecret = result.clientSecret;
        
        // Отображаем результат
        resultElement.textContent = JSON.stringify(result, null, 2);
        resultElement.classList.remove('hidden');
        
        // Отображаем информацию о налоге
        if (result.tax) {
          const taxInfo = result.tax;
          const taxDetails = document.getElementById('taxDetails');
          
          // Рассчитываем итоговую сумму
          const baseAmount = parseInt(amount);
          const taxAmount = taxInfo.amount;
          const totalAmount = baseAmount + taxAmount;
          
          // Устанавливаем значения в сводке
          document.getElementById('subtotal').textContent = formatCurrency(baseAmount, currency);
          document.getElementById('taxAmount').textContent = formatCurrency(taxAmount, currency);
          document.getElementById('totalAmount').textContent = formatCurrency(totalAmount, currency);
          
          // Формируем информацию о налоге
          taxDetails.innerHTML = `
            <p><strong>Tax Rate:</strong> ${(taxInfo.rate * 100).toFixed(2)}%</p>
            <p><strong>Tax Amount:</strong> ${formatCurrency(taxInfo.amount, currency)}</p>
            <p><strong>Tax Description:</strong> ${taxInfo.label || 'No tax information'}</p>
          `;
          
          taxSummary.classList.remove('hidden');
        }
        
        // Показываем форму оплаты
        document.getElementById('checkoutContainer').classList.remove('hidden');
        
        // Инициализируем элемент карты
        setupStripeElements();
        
      } catch (error) {
        console.error('Error:', error);
        errorElement.textContent = error.message;
        errorElement.classList.remove('hidden');
      }
    });
    
    // 2. Настройка Stripe Elements
    function setupStripeElements() {
      if (card) {
        card.destroy();
      }
      
      const elements = stripe.elements();
      card = elements.create('card');
      card.mount('#card-element');
      
      // Обработка ошибок валидации карты
      card.addEventListener('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
          displayError.textContent = event.error.message;
          displayError.classList.remove('hidden');
        } else {
          displayError.textContent = '';
          displayError.classList.add('hidden');
        }
      });
    }
    
    // 3. Подтверждение платежа
    document.getElementById('submitPayment').addEventListener('click', async function() {
      try {
        const result = await stripe.confirmCardPayment(clientSecret, {
          payment_method: {
            card: card,
            billing_details: {
              address: {
                country: document.getElementById('country').value
              }
            }
          }
        });
        
        if (result.error) {
          throw new Error(result.error.message);
        } else if (result.paymentIntent && result.paymentIntent.status === 'succeeded') {
          const confirmationResult = document.getElementById('confirmationResult');
          confirmationResult.textContent = 'Payment successful! Payment Intent ID: ' + result.paymentIntent.id;
          confirmationResult.classList.remove('hidden');
        }
      } catch (error) {
        const errorElement = document.getElementById('card-errors');
        errorElement.textContent = error.message;
        errorElement.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>