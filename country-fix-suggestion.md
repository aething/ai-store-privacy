# Анализ проблемы с передачей страны в API создания PaymentIntent

## Проблема

Параметр `country` в запросах к эндпоинту `/api/create-payment-intent` не проходит корректно, из-за чего система всегда использует значение по умолчанию (`'unknown'`) вместо фактически переданного значения.

## Результаты анализа

Проведенный анализ кода и тестовые запросы показывают:

1. В логах видно, что страна пользователя (`customerData?.country`) определяется корректно, но далее при создании PaymentIntent она всегда заменяется на значение `'unknown'`.

2. Тестовые запросы с параметром `force_country: true` не решают проблему. В логах все равно видно, что значение `country` в PaymentIntent метаданных равно `'unknown'`.

3. Параметры, передаваемые в запросе (в теле запроса JSON), включают правильные значения, но при обработке запроса на сервере, они не учитываются должным образом.

## Причина проблемы

Изучение серверного кода в `server/routes.ts` (строки 777-1241) показывает, что проблема в строке 804:

```javascript
const country = customerData?.country || null;
```

и в метаданных в строке 810:

```javascript
country: country || 'unknown'
```

В этом коде страна всегда берется из профиля пользователя (`customerData?.country`), а параметр `country` из запроса полностью игнорируется.

Кроме того, после строки 1118-1147 есть логика по умолчанию:

```javascript
// Если страна не указана или это Германия, применяем немецкий НДС
if (!country || country === 'DE') {
  // Устанавливаем значения для Германии
  const defaultCountry = 'DE';
  taxRate = 0.19;
  taxLabel = 'MwSt. 19%';
  
  // ...
}
```

Это объясняет, почему независимо от запрашиваемой страны, система всегда возвращает немецкий НДС (19%).

## Предлагаемое решение

Необходимо модифицировать код серверного обработчика `/api/create-payment-intent` следующим образом:

1. Добавить учет параметра `country` из запроса:

```javascript
// Использовать страну из запроса, если она передана явно, иначе из профиля пользователя
const country = req.body.country || req.query.country || customerData?.country || null;
```

2. Добавить явную поддержку флага `force_country`:

```javascript
// Если передан флаг force_country, то принудительно используем страну из запроса
const forceCountry = req.body.force_country === true || req.query.force_country === 'true';
const effectiveCountry = forceCountry && req.body.country ? req.body.country : country; 
```

3. Использовать `effectiveCountry` везде, где сейчас используется `country`

## Выводы

Текущая реализация серверного кода не учитывает параметр страны из запроса, что приводит к неправильному расчету налогов. Предложенное решение позволит клиентскому коду явно указывать страну для расчета налогов, что особенно важно при тестировании и отладке.

Модуль `tax-demo-route.ts` уже содержит правильную логику для принудительного указания страны с использованием флагов `override_user_country` и `force_country`, но основной эндпоинт `/api/create-payment-intent` её не использует.