# Реализация налогов для международной платежной системы

## Общий обзор изменений

В ходе разработки международной платежной системы были внесены следующие изменения:

1. Добавлена поддержка расчета и отображения налогов для разных стран мира
2. Уникальные налоговые ставки, метки и обозначения для каждой страны
3. Корректная обработка случаев с неизвестной страной
4. Комплексное тестирование налоговой логики

## Ключевые особенности реализации

1. **Определение страны пользователя**:
   - Реализовано гибкое определение страны покупателя с проверкой нескольких источников
   - Поддержка принудительного указания страны для тестирования (`force_country`)
   - Корректная обработка ситуаций, когда страна не определена
   
2. **Налоговые ставки**:
   - Уникальные ставки НДС для каждой страны: Германия (19%), Франция (20%), Италия (22%), Испания (21%) и т.д.
   - Метки отображаются на языке страны: MwSt. (Германия), TVA (Франция), IVA (Италия/Испания)
   - Налоги не применяются для США и неизвестных стран (ставка 0%)
   
3. **Интеграция со Stripe**:
   - Для каждой страны создается отдельный налоговый объект в Stripe
   - Информация о налоге добавляется в метаданные платежа для последующего аудита
   - Корректная обработка exclusive/inclusive налогов
   
4. **Форматирование и отображение**:
   - Налог отображается отдельной строкой в деталях платежа
   - Название налога зависит от страны покупателя
   - Суммы форматируются согласно локали пользователя

## Тестирование

Реализована всесторонняя система тестирования налоговой логики:

1. Скрипт `test-payment-with-tax.sh` для проверки:
   - Корректности расчета налога для разных стран
   - Правильности определения метки налога
   - Корректности вычисления итоговой суммы

2. Проверка включает следующие сценарии:
   - Пользователи из разных стран ЕС с разными ставками НДС
   - Пользователи из США (без налога)
   - Ситуации с неизвестной страной

3. Метрики тестирования:
   - Успешно протестированы ставки для DE (19%), FR (20%), IT (22%), ES (21%), US (0%)
   - Проверены специальные символы и метки на национальных языках

## Примеры расчетов

| Страна | Базовая сумма | Ставка | Сумма налога | Итоговая сумма | Метка |
|--------|--------------|--------|--------------|----------------|-------|
| DE | 100.00 EUR | 19% | 19.00 EUR | 119.00 EUR | MwSt. 19% |
| FR | 100.00 EUR | 20% | 20.00 EUR | 120.00 EUR | TVA 20% |
| IT | 100.00 EUR | 22% | 22.00 EUR | 122.00 EUR | IVA 22% |
| ES | 100.00 EUR | 21% | 21.00 EUR | 121.00 EUR | IVA 21% |
| US | 100.00 USD | 0% | 0.00 USD | 100.00 USD | No Sales Tax |
| unknown | 100.00 EUR | 0% | 0.00 EUR | 100.00 EUR | No Tax (Unknown Location) |

## Дальнейшие улучшения

1. Добавление поддержки пониженных ставок НДС для определенных категорий товаров
2. Расчет и отображение налогов на уровне штатов США
3. Расширение списка поддерживаемых стран
4. Оптимизация кэширования налоговых ставок
