# Руководство по тестированию оффлайн режима

Это руководство описывает процесс тестирования оффлайн-функциональности PWA приложения и содержит рекомендации по отладке проблем с кэшированием и Service Worker.

## Основные инструменты тестирования

Для тестирования оффлайн-режима доступны следующие инструменты:

1. **Страница оффлайн-тестирования** - доступна по адресу `/offline-test` в приложении
2. **Расширенная HTML-страница тестирования** - расположена по адресу `/offline-test.html`
3. **Консольная утилита тестирования** - доступна через `window.appDebug` в браузерной консоли

## Тестирование с использованием встроенных инструментов

### Страница оффлайн-тестирования в приложении

1. Перейдите на страницу `/offline-test` через навигацию приложения
2. Проверьте статус Service Worker и состояние кэша
3. Используйте кнопки для тестирования различных сценариев
4. При необходимости очистите или обновите кэш приложения

### Расширенная HTML-страница тестирования

Эта страница работает независимо от основного приложения и может быть полезна для отладки:

1. Перейдите на `/offline-test.html` напрямую в браузере
2. Используйте панель управления для проверки состояния кэша и Service Worker
3. Тестируйте различные сценарии оффлайн-поведения

### Консольные команды

В консоли браузера доступен глобальный объект `window.appDebug` с следующими методами:

```javascript
// Проверка поддержки оффлайн-режима
window.appDebug.checkOfflineSupport()

// Очистка кэша Service Worker
window.appDebug.clearServiceWorkerCache()

// Обновление кэша
window.appDebug.refreshServiceWorkerCache()

// Проверка, находится ли приложение в оффлайн-режиме
window.appDebug.isOffline()

// Полный сброс кэша приложения
window.appDebug.resetAppCache()

// Доступ к внутренним API Service Worker
window.appDebug.swAPI.getVersion()
window.appDebug.swAPI.getCacheInfo()
window.appDebug.swAPI.cacheUrls(['/', '/index.html'])
window.appDebug.swAPI.checkResource('/offline.html')
```

## Процедура ручного тестирования

### Базовое тестирование оффлайн режима

1. **Подготовка**:
   - Убедитесь, что Service Worker активен и приложение загружено в онлайн-режиме
   - Проверьте, что оффлайн-страница и ключевые ресурсы кэшированы

2. **Симуляция оффлайн-режима**:
   - Откройте инструменты разработчика (F12)
   - Перейдите на вкладку Network
   - Активируйте опцию "Offline"

3. **Тестирование**:
   - Обновите страницу (F5)
   - Проверьте, что приложение продолжает работать и отображается корректно
   - Попробуйте перейти к другим кэшированным страницам
   - Попробуйте перейти к странице, которая не была кэширована (должна отобразиться оффлайн-страница)

4. **Возврат в онлайн-режим**:
   - Отключите опцию "Offline" в инструментах разработчика
   - Проверьте, что приложение автоматически восстановило полную функциональность

### Расширенное тестирование

1. **Тестирование очистки кэша**:
   - Перейдите на страницу `/offline-test`
   - Нажмите "Очистить кэш"
   - Попробуйте перезагрузить страницу в оффлайн-режиме (должна отобразиться ошибка сети)
   - Вернитесь в онлайн-режим
   - Проверьте, что страница снова начала кэшироваться

2. **Тестирование обновления Service Worker**:
   - После внесения изменений в `service-worker.js`
   - Перейдите на любую страницу приложения
   - Проверьте в консоли сообщение о доступном обновлении
   - Подтвердите установку обновления
   - Проверьте, что страница перезагружена с новой версией Service Worker

## Распространенные проблемы и их решение

### Проблема: Service Worker не регистрируется

**Возможные причины и решения**:
- Проверьте, поддерживает ли браузер Service Worker
- Убедитесь, что `service-worker.js` доступен по корректному пути
- Проверьте консоль на наличие ошибок JavaScript

### Проблема: Ресурсы не кэшируются

**Возможные причины и решения**:
- Проверьте список CORE_ASSETS в `service-worker.js`
- Убедитесь, что ресурсы доступны по указанным путям
- Проверьте политику CORS, если ресурсы загружаются с другого домена

### Проблема: Старая версия Service Worker не обновляется

**Возможные причины и решения**:
- Проверьте, изменилась ли версия в `service-worker.js` (APP_VERSION)
- Попробуйте очистить все регистрации Service Worker и кэш
- В крайнем случае, попробуйте очистить данные сайта в настройках браузера

## Дополнительные рекомендации

- **Проверка на разных устройствах**: Тестируйте оффлайн-режим на различных устройствах и браузерах
- **Симуляция медленной сети**: Используйте опции Network throttling в инструментах разработчика
- **Мониторинг использования кэша**: Следите за размером кэша, чтобы избежать переполнения хранилища
- **Регулярное обновление оффлайн-ресурсов**: Обновляйте кэшированные ресурсы при выпуске новых версий приложения

## Технические детали

### Структура кэша

Приложение использует следующие кэши:
- `ai-store-v3` - основной кэш для статических ресурсов
- `ai-store-offline-v3` - кэш для оффлайн-страницы и ресурсов
- `ai-store-dynamic-v3` - кэш для динамически загружаемого контента

### Стратегии кэширования

- **HTML-страницы**: Network First, затем кэш, затем оффлайн-страница
- **Изображения и статические ресурсы**: Cache First, затем сеть, затем заглушка
- **API и динамичные данные**: Network Only (не кэшируются)

### Жизненный цикл Service Worker

1. **Регистрация**: При загрузке приложения через `registerServiceWorker.ts`
2. **Установка**: Кэширование основных ресурсов в обработчике `install`
3. **Активация**: Удаление устаревших кэшей в обработчике `activate`
4. **Обработка запросов**: Перехват и обработка запросов в обработчике `fetch`
5. **Обновление**: Уведомление пользователя о доступных обновлениях и предложение обновить приложение