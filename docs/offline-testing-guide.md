# Руководство по тестированию офлайн-режима PWA

В этом руководстве описаны методы тестирования Progressive Web App (PWA) в офлайн-режиме, чтобы обеспечить надежную работу приложения при отсутствии интернет-соединения.

## Зачем нужен офлайн-режим?

Поддержка офлайн-режима является одним из ключевых требований для PWA. Она позволяет:
- Улучшить пользовательский опыт при плохом соединении
- Обеспечить базовую функциональность без интернета
- Уменьшить зависимость от качества соединения
- Соответствовать требованиям Google Play для PWA

## Инструменты для тестирования

1. **Chrome DevTools**:
   - Вкладка Network с опцией "Offline"
   - Вкладка Application > Service Workers для управления service worker
   - Вкладка Application > Cache Storage для проверки кэшированных ресурсов

2. **Эмуляторы и устройства**:
   - Android-эмулятор с режимом полета
   - Реальные устройства в режиме полета

3. **PWA-валидаторы**:
   - Lighthouse (встроен в Chrome DevTools)
   - PWA Builder (https://www.pwabuilder.com/)

## Подготовка к тестированию офлайн-режима

### 1. Проверка конфигурации Service Worker

```javascript
// Проверьте наличие всех необходимых файлов в кэше
const CACHE_NAME = 'ai-store-v1';
const STATIC_ASSETS = [
  '/',
  '/index.html',
  '/manifest.json',
  '/offline.html',
  // ... другие важные ресурсы
];

self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => {
        return cache.addAll(STATIC_ASSETS);
      })
  );
});
```

### 2. Подготовка офлайн-страницы

Убедитесь, что offline.html существует и корректно настроена:
- Содержит базовую информацию о приложении
- Использует только кэшированные ресурсы
- Предоставляет возможность повторной попытки соединения

### 3. Проверка Manifest

В файле manifest.json должны быть корректно указаны:
- name и short_name
- icons для разных размеров
- start_url и scope
- display (рекомендуется standalone или fullscreen)
- theme_color и background_color

## Пошаговое тестирование офлайн-режима

### Шаг 1: Первоначальная загрузка и кэширование

1. Откройте приложение при включенном интернете
2. Дождитесь полной загрузки страницы
3. Проверьте в Chrome DevTools > Application > Service Workers, что service worker успешно зарегистрирован
4. Проверьте в Cache Storage наличие кэшированных ресурсов

### Шаг 2: Переход в офлайн-режим

1. В Chrome DevTools перейдите на вкладку Network
2. Включите опцию "Offline"
3. Обновите страницу (F5 или Ctrl+R)

### Шаг 3: Проверка офлайн-функциональности

1. Убедитесь, что приложение не показывает стандартную ошибку браузера "нет соединения"
2. Проверьте отображение офлайн-страницы или кэшированного контента
3. Проверьте работу навигации по кэшированным страницам
4. Проверьте все элементы UI на корректное отображение

### Шаг 4: Тестирование восстановления соединения

1. Отключите режим "Offline" в DevTools
2. Проверьте, что приложение автоматически восстанавливает работу
3. Проверьте, что новый контент загружается корректно

### Шаг 5: Тестирование на устройстве/эмуляторе

1. Установите PWA на устройство или эмулятор
2. Используйте приложение с включенным интернетом
3. Включите режим полета
4. Проверьте работу приложения в офлайн-режиме
5. Отключите режим полета и проверьте восстановление работы

## Расширенное тестирование

### Тестирование при плохом соединении

1. В Chrome DevTools > Network выберите вместо "Offline" профили с плохим соединением (например, "Slow 3G")
2. Проверьте производительность приложения и корректность загрузки

### Тестирование обновления кэша

1. Внесите изменения в кэшируемые файлы (например, index.html)
2. Обновите версию в CACHE_NAME (например, 'ai-store-v2')
3. Проверьте, что при следующем посещении пользователи получают обновленную версию

### Тестирование кэширования API-запросов

Если приложение использует API, проверьте кэширование запросов:

```javascript
self.addEventListener('fetch', event => {
  // Проверка, является ли запрос API-запросом
  if (event.request.url.includes('/api/')) {
    event.respondWith(
      fetch(event.request)
        .then(response => {
          // Кэшируем ответ API
          const clonedResponse = response.clone();
          caches.open(DATA_CACHE_NAME)
            .then(cache => cache.put(event.request, clonedResponse));
          return response;
        })
        .catch(() => {
          // Возвращаем кэшированный ответ, если есть
          return caches.match(event.request);
        })
    );
  }
});
```

## Устранение проблем

### Проблема: Service Worker не кэширует файлы

**Проверка**: 
- Изучите Chrome DevTools > Console для ошибок
- Проверьте путь к файлам в STATIC_ASSETS

**Решение**:
- Исправьте пути к файлам
- Убедитесь, что обращаетесь к локальным файлам, а не CDN с другого домена

### Проблема: Кэшированные файлы не обновляются

**Проверка**:
- Проверьте логику обновления кэша в service worker

**Решение**:
- Обновите CACHE_NAME при изменении кэшируемых файлов
- Реализуйте стратегию очистки устаревших кэшей

### Проблема: Офлайн-страница не отображается

**Проверка**:
- Проверьте наличие offline.html в кэше
- Проверьте логику обработки офлайн-состояния

**Решение**:
- Добавьте offline.html в STATIC_ASSETS
- Исправьте обработчик fetch для офлайн-режима

## Контрольный список для завершения тестирования

- [ ] Service Worker успешно регистрируется
- [ ] Все необходимые файлы кэшируются
- [ ] Приложение корректно работает в офлайн-режиме
- [ ] Офлайн-страница отображается при отсутствии доступа к некэшированным страницам
- [ ] Приложение восстанавливает работу при восстановлении соединения
- [ ] PWA проходит проверку в Lighthouse с хорошими результатами
- [ ] Приложение корректно работает на разных устройствах в офлайн-режиме