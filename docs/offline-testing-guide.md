# Руководство по тестированию оффлайн-режима PWA

Это руководство описывает процесс тестирования оффлайн-функциональности Progressive Web App (PWA) для AI Store. Оффлайн-режим является важной частью PWA и требуется для успешного размещения в Google Play через TWA (Trusted Web Activity).

## Содержание

1. [Обзор оффлайн-функциональности](#обзор-оффлайн-функциональности)
2. [Предварительные требования](#предварительные-требования)
3. [Тестирование в браузере](#тестирование-в-браузере)
4. [Тестирование в эмуляторе Android](#тестирование-в-эмуляторе-android)
5. [Тестирование на физическом устройстве](#тестирование-на-физическом-устройстве)
6. [Проверка кэширования ресурсов](#проверка-кэширования-ресурсов)
7. [Распространенные проблемы и решения](#распространенные-проблемы-и-решения)
8. [Контрольный список для проверки](#контрольный-список-для-проверки)

## Обзор оффлайн-функциональности

AI Store PWA обеспечивает следующие возможности в оффлайн-режиме:

- Базовая навигация по предварительно кэшированным страницам
- Отображение оффлайн-страницы для запросов, которые не могут быть обслужены из кэша
- Кэширование статических ресурсов (CSS, JavaScript, изображения)
- Автоматическое обновление кэша при появлении новой версии
- Стратегия Stale-While-Revalidate для оптимального пользовательского опыта

## Предварительные требования

Для тестирования оффлайн-режима вам потребуется:

- Современный браузер (Chrome 70+, Firefox 65+, Safari 13+)
- Инструменты разработчика браузера
- (Опционально) Эмулятор Android или физическое устройство Android
- (Опционально) Android Studio для эмуляции сетевых условий

## Тестирование в браузере

### Подготовка

1. Откройте приложение AI Store в браузере
2. Убедитесь, что страница полностью загружена
3. Перейдите на несколько различных страниц для активации кэширования

### Тестирование через инструменты разработчика

1. Откройте инструменты разработчика браузера (F12 или Ctrl+Shift+I)
2. Перейдите на вкладку "Application" (Chrome) или "Storage" (Firefox)
3. Найдите раздел "Service Workers" и убедитесь, что Service Worker активен
4. Перейдите на вкладку "Network" (Сеть)
5. Включите опцию "Offline" (Без сети)
6. Обновите страницу (F5)

### Ожидаемое поведение в оффлайн-режиме

- Основная страница должна загружаться из кэша
- Изображения, стили и скрипты должны отображаться корректно
- При переходе на некэшированную страницу должна отображаться оффлайн-страница
- Кнопки перехода и обновления на оффлайн-странице должны работать
- Индикатор состояния сети должен корректно отображать оффлайн-статус

### Использование встроенного инструмента тестирования

Для удобства тестирования в приложении есть встроенный инструмент на странице `/offline-test`, который позволяет:

1. Проверять состояние сервис-воркера
2. Анализировать содержимое кэша
3. Очищать кэш для повторного тестирования
4. Проверять доступность оффлайн-страницы

## Тестирование в эмуляторе Android

### Настройка эмулятора

1. Откройте Android Studio
2. Запустите эмулятор Android (API 23+)
3. Откройте Chrome в эмуляторе
4. Перейдите на сайт AI Store

### Симуляция оффлайн-режима

1. В Android Studio перейдите в Extended Controls эмулятора
2. Выберите раздел "Cellular"
3. Установите "Signal strength" в "None" или выберите "Network type" как "None"

### Тестирование установленного PWA

1. В Chrome нажмите меню (три точки) > "Установить приложение"
2. Установите AI Store как PWA на главный экран
3. Закройте Chrome и запустите приложение с рабочего стола
4. Перейдите в режим "Без сети" в эмуляторе
5. Проверьте работу приложения в оффлайн-режиме

## Тестирование на физическом устройстве

### Подготовка устройства

1. Подключите Android-устройство к компьютеру
2. Включите режим разработчика на устройстве
3. Включите опцию USB Debugging в настройках разработчика

### Установка и тестирование

1. Откройте Chrome на устройстве и перейдите на сайт AI Store
2. Установите PWA через меню Chrome > "Установить приложение"
3. Переведите устройство в режим "В самолете" для симуляции отсутствия сети
4. Запустите установленное приложение с рабочего стола
5. Проверьте функциональность в оффлайн-режиме

## Проверка кэширования ресурсов

### Через инструменты разработчика

1. Откройте вкладку "Application" > "Cache Storage" в инструментах разработчика Chrome
2. Проверьте содержимое каждого кэша (`ai-store-v2`, `ai-store-offline`, `ai-store-dynamic`)
3. Убедитесь, что ключевые ресурсы кэшируются:
   - `/offline.html`
   - `/index.css`
   - `/manifest.json`
   - `/images/image-placeholder.svg`
   - Основные JavaScript файлы

### Через встроенный инструмент

1. Перейдите на страницу `/offline-test`
2. Нажмите кнопку "Проверить кэш"
3. Проанализируйте список кэшированных ресурсов и общий размер кэша

## Распространенные проблемы и решения

### Service Worker не регистрируется

**Симптомы:** Оффлайн-режим не работает, в консоли есть ошибки регистрации.

**Решение:**
- Убедитесь, что HTTPS включен (или localhost используется для тестирования)
- Проверьте, что service-worker.js находится в корневой директории
- Проверьте наличие ошибок синтаксиса в service-worker.js

### Ресурсы не кэшируются

**Симптомы:** В оффлайн-режиме страницы отображаются без стилей или изображений.

**Решение:**
- Убедитесь, что пути к статическим ресурсам в массиве STATIC_ASSETS корректны
- Проверьте события fetch и стратегии кэширования
- Очистите кэш и полностью перезагрузите страницу для повторной активации Service Worker

### Оффлайн-страница не отображается

**Симптомы:** В оффлайн-режиме приложение показывает стандартную страницу ошибки браузера.

**Решение:**
- Проверьте, что `/offline.html` кэшируется при установке Service Worker
- Убедитесь, что в обработчике fetch для навигационных запросов настроен fallback на offline.html
- Проверьте, что путь к оффлайн-странице корректный в Service Worker

## Контрольный список для проверки

Используйте следующий контрольный список для подтверждения корректной работы оффлайн-режима:

- [ ] Service Worker успешно регистрируется и активируется
- [ ] Основные статические ресурсы кэшируются автоматически
- [ ] Приложение работает в оффлайн-режиме
- [ ] Оффлайн-страница отображается при запросе некэшированных ресурсов
- [ ] Индикатор состояния сети корректно отображает статус соединения
- [ ] Изображения имеют корректные заглушки в оффлайн-режиме
- [ ] Переход между кэшированными страницами работает корректно
- [ ] После восстановления соединения приложение возвращается к нормальной работе
- [ ] Обновление Service Worker происходит корректно при изменении кода
- [ ] PWA правильно устанавливается на домашний экран